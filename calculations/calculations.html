<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> قصاصة الراتب </title>

    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            --primary-color: #0056b3; 
            --secondary-color: #007bff; 
            --background-light: #f5f8fa;
            --background-card: #ffffff;
            --text-dark: #212529;
            --text-light: #ffffff;
            --reset-color: #dc3545;
            --warning-color: #ffc107;
            --print-color: #28a745;
            --input-height: 48px; 
        }

        /* تطبيق box-sizing على جميع العناصر لضمان دقة الأبعاد */
        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            font-family: 'Rubik', sans-serif;
            background: var(--background-light);
            margin: 0;
            padding: 0;
            color: var(--text-dark);
            direction: rtl; 
            position: relative; 
        }
        
        /* ------------------------------------- */
        /* تنسيق زر الرجوع الجديد (دائري وأعلى اليمين) */
        /* ------------------------------------- */
        .back-link {
            position: absolute;
            top: 75px; 
            right: 100px; 
            
            display: flex;
            align-items: center; 
            justify-content: center; 
            
            text-decoration: none;
            padding: 10px; 
            border-radius: 50%; 
            
            background-color: var(--secondary-color); 
            color: var(--text-light); 
            font-size: 16px;
            font-weight: 500;
            
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
            transition: background-color 0.3s, transform 0.2s, box-shadow 0.3s;
            
            z-index: 1000; 
            width: 40px; 
            height: 40px; 
        }

        .back-link i {
            margin-right: 0; 
            font-size: 18px; 
            transform: rotate(180deg);
        }

        .back-link:hover {
            background-color: #0060cc;
            transform: translateY(-1px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
        }
        
        /* ------------------------------------- */

        .container {
            max-width: 960px;
            margin: 30px auto;
            background: var(--background-card);
            padding: 35px;
            border-radius: 20px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
            min-height: calc(100vh - 60px);
            position: relative;
            padding-bottom: 80px;
        }

        h2 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 32px;
            font-weight: 700;
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 20px; 
        }

        .form-group label {
            font-size: 17px;
            font-weight: 600;
            color: var(--text-dark);
            width: 35%; 
            min-width: 150px; 
            text-align: right;
            flex-shrink: 0; 
        }

        input[type="number"],
        input[type="date"],
        select {
            flex-grow: 1; 
            width: 100%; 
            height: var(--input-height); 
            padding: 0 14px; 
            font-size: 17px;
            border-radius: 10px;
            border: 1px solid #ced4da;
            background: #f8f9fa;
            transition: border-color 0.3s, box-shadow 0.3s;
            appearance: none; 
            -webkit-appearance: none;
            -moz-appearance: none;
        }
        
        select {
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23007bff%22%20d%3D%22M287%20197.8L146.2%2057%205.4%20197.8z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: left 10px center; 
            background-size: 12px 12px;
            padding-left: 30px; 
        }

        input:focus, select:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 0.25rem rgba(0, 123, 255, 0.25);
            background: var(--background-card);
            outline: none;
        }
        
        .hidden {
            display: none !important;
        }

        .btn-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            padding-right: 35%; 
            min-width: 400px; 
        }

        button {
            flex-grow: 1;
            padding: 16px;
            border-radius: 10px;
            border: none;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        button i {
            margin-left: 10px;
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        #calculateBtn {
            background: var(--primary-color);
            color: var(--text-light);
        }
        #calculateBtn:hover {
            background: #004599;
            transform: translateY(-2px);
        }

        #resetBtn {
            background: var(--reset-color);
            color: var(--text-light);
        }
        #resetBtn:hover {
            background: #c82333;
            transform: translateY(-2px);
        }
        
        #printBtn {
            background: var(--print-color);
            color: var(--text-light);
            display: none; 
        }
        #printBtn:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .result-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }

        .result {
            margin-bottom: 15px; 
            padding: 15px;
            background: #e9f5ff;
            border-left: 5px solid var(--secondary-color);
            border-radius: 8px;
            font-size: 18px; 
            font-weight: 500;
            color: var(--primary-color);
            margin-top: 0; 
        }
        
        .warning {
            margin-top: 15px; 
            margin-bottom: 15px; 
            padding: 15px;
            background: #fff3cd;
            border-left: 5px solid var(--warning-color);
            border-radius: 8px;
            font-size: 17px; 
            font-weight: 600;
            color: #856404;
        }

        .details {
            margin-top: 15px; 
            margin-bottom: 0; 
            padding: 20px;
            background: #f8fafd;
            border: 1px solid #dee2e6;
            border-radius: 12px;
            font-size: 16px; 
            color: var(--text-dark);
            line-height: 1.8;
        }
        
        .promo-result {
            background: #e6ffec; 
            border-left: 5px solid var(--print-color); 
            color: #155724; 
        }
        
        .promo-result span {
            font-weight: 700;
            color: var(--print-color);
        }

        .details strong {
            color: var(--primary-color);
            font-weight: 700;
        }

        .details span {
            font-family: 'Rubik', sans-serif;
            font-weight: 600;
            margin-left: 5px;
        }
        
        .promo-list {
            margin-top: 10px;
            padding-right: 0;
            list-style: none;
        }
        .promo-list li {
            padding: 5px 0 5px 10px;
            border-bottom: 1px dotted #ccc;
            font-size: 16px;
        }
        .promo-list li:last-child {
            border-bottom: none;
        }
        
        .details ul {
            direction: rtl; 
            text-align: right;
            padding-right: 25px; 
            list-style-position: outside; 
            list-style-type: disc; 
        }

        .details li {
            text-align: right;
            direction: rtl;
            padding-right: 0; 
            margin-right: 0;
        }
        
        .footer {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 20px 35px;
            margin-top: 40px;
            /* تم إزالة border-top: 1px solid #000; */
            text-align: center;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-dark);
            background: transparent;
        }

        .footer p {
            margin: 0;
            padding: 0;
        }

        .footer hr {
            border: none;
            /* تم إزالة border-top: 1px solid #000; */
            margin: 0 0 15px 0;
        }
        
        #serviceDuration {
            background: #fff7e6; 
            border-left: 5px solid var(--warning-color);
            color: #856404;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .back-link {
                top: 15px; 
                right: 25px; 
                left: auto; 
                padding: 8px;
                font-size: 14px;
                width: 36px;
                height: 36px;
            }
            .back-link i {
                font-size: 16px;
                transform: rotate(180deg);
            }
            .container { margin: 15px; padding: 25px; padding-bottom: 70px; border-radius: 15px; }
            h2 { font-size: 28px; margin-bottom: 20px; }
            
            .form-group {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            .form-group label {
                width: 100%; 
                text-align: right;
                margin-bottom: 5px;
            }
            input[type="number"],
            input[type="date"],
            select {
                width: 100%; 
            }
            .btn-group { 
                flex-direction: column; 
                gap: 10px;
                padding-right: 0; 
                min-width: auto;
            }
            button { font-size: 17px; padding: 14px; }
            .result { font-size: 17px; padding: 14px; }
            .details { font-size: 15px; padding: 15px; }
            .footer { padding: 15px 25px; }
        }

        @media print {
            body { background: white; }
            .container { 
                box-shadow: none; 
                margin: 0; 
                padding: 0;
                max-width: 100%;
            }
            .form-group, .btn-group, h2, .back-link { display: none !important; }
            .result-section { border-top: none; padding-top: 0; }
            .result, .warning, .details {
                page-break-inside: avoid;
                border: 1px solid #333 !important;
                background: #f9f9f9 !important;
                padding: 10px !important;
                margin-bottom: 10px !important;
            }
            .details ul { 
                padding-right: 25px !important; 
                direction: rtl !important; 
                text-align: right !important;
                list-style-position: outside !important;
            }
            .details li {
                direction: rtl !important; 
                text-align: right !important;
            }
            .promo-list { list-style: none; padding-right: 0; }
            .footer { 
                display: block !important;
                position: relative !important;
                /* تم إزالة border-top: 1px solid #000 !important; */
                padding: 15px !important;
                margin-top: 20px !important;
            }
            .footer hr { /* تم حذف الخط السميك */
                display: none !important;
            }
        }
    </style>
</head>
<body>

<a href="https://engsabaawi.github.io" class="back-link" title="العودة إلى الصفحة الرئيسية">
    <i class="fas fa-chevron-left"></i> 
</a>
<div class="container">

    <h2>قصاصة الراتب</h2>

    <form id="salaryForm">
        <div class="form-group">
            <label for="dateOfAppointment">تاريخ التعيين</label>
            <input type="date" id="dateOfAppointment" name="dateOfAppointment">
        </div>

        <div class="form-group">
            <label for="degreeType">الشهادة</label>
            <select id="degreeType" name="degreeType">
                <option value="diploma">دبلوم</option>
                <option value="bachelor" selected>بكلوريوس</option>
                <option value="master">ماجستير</option>
                <option value="phd">دكتوراه</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="workType">تصنيف الوظيفة</label>
            <select id="workType" name="workType">
                <option value="field" selected>ميداني</option>
                <option value="admin">إداري</option>
            </select>
        </div>

        <div class="form-group">
            <label for="workShift">نوع الدوام</label>
            <select id="workShift" name="workShift">
                <option value="morning" selected>صباحي</option>
                <option value="shift">مناوب</option>
            </select>
        </div>

        <div id="overtimeHoursBox" class="form-group">
            <label for="overtimeHoursInput">عدد الساعات الإضافية</label>
            <input type="number" id="overtimeHoursInput" name="overtimeHoursInput" min="0" value="" placeholder="أدخل عدد الساعات">
        </div>

        <div id="shiftsBox" class="form-group hidden">
            <label for="shifts">عدد الشفتات</label>
            <select id="shifts" name="shifts">
                <option value="6" selected>لا توجد ساعات إضافية</option>
                <option value="7">7 شفتات</option>
                <option value="8">8 شفتات</option>
            </select>
        </div>

        <div class="form-group">
            <label for="position">المنصب</label>
            <select id="position" name="position">
                <option value="none" selected>لا يوجد</option>
                <option value="section-head">مسؤول شعبة</option>
                <option value="department-head">مسؤول قسم</option>
                <option value="director">مدير هيئة / معاون مدير / مدير عام</option>
            </select>
        </div>

        <div class="form-group">
            <label for="grade">الدرجة الحالية</label>
            <select id="grade" name="grade">
                <option value="8" selected>8</option>
                <option value="7">7</option>
                <option value="6">6</option>
                <option value="5">5</option>
                <option value="4">4</option>
                <option value="3">3</option>
                <option value="2">2</option>
                <option value="1">1</option>
            </select>
        </div>

        <div class="form-group">
            <label for="stage">المرحلة الحالية</label>
            <select id="stage" name="stage">
                <option value="1" selected>1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
                <option value="11">11</option>
            </select>
        </div>

        <div class="form-group">
            <label for="locationAllowance">مخصصات الموقع</label>
            <input type="number" id="locationAllowance" name="locationAllowance" min="0" placeholder="أدخل المبلغ">
        </div>

        
        <div class="form-group">
            <label for="social">الحالة الاجتماعية</label>
            <select id="social" name="social">
                <option value="single" selected>أعزب</option>
                <option value="married">متزوج</option>
            </select>
        </div>

        <div id="kidsBox" class="form-group hidden">
            <label for="kids">عدد الأطفال</label>
            <select id="kids" name="kids">
                <option value="0" selected>0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
            </select>
        </div>

        <div class="form-group">
            <label for="bonusMonths">عدد أشهر القدم (كتب الشكر)</label>
            <input type="number" id="bonusMonths" name="bonusMonths" value="0" min="0">
        </div>

        <div class="btn-group">
            <button type="button" id="calculateBtn"><i class="fas fa-hand-holding-usd"></i> احسب النتائج</button>
            <button type="button" id="resetBtn"><i class="fas fa-redo-alt"></i> تصفير الحقول</button>
            <button type="button" id="printBtn"><i class="fas fa-print"></i> طباعة القصاصة PDF</button>
        </div>
    </form>

    <div class="result-section">
        <div id="salaryResult" class="result hidden"></div>
        <div id="serviceDuration" class="result hidden"></div>
        <div id="detailsBox" class="details hidden"></div>
    </div>

    <div class="footer">
        <p>تم تصميم الموقع كلياً بواسطة المهندس مالك محمد</p>
    </div>

</div>

<script>
    // القيم الأساسية للراتب
    const gradeBase = { 8: 260000, 7: 296000, 6: 362000, 5: 429000, 4: 509000, 3: 600000, 2: 723000, 1: 910000 };
    const stageAddLogic = (grade) => {
        const defaultAdd = { 8: 3000, 7: 6000, 6: 6000, 5: 6000, 4: 8000, 3: 10000, 2: 17000, 1: 20000 };
        return defaultAdd[grade] || 0;
    };
    
    // تعريف الاستقطاعات الثابتة الجديدة
    const DEDUCTIONS = {
        HEALTH_INSURANCE: 25000, 
        SOCIAL_SOLIDARITY: 2000, 
        CHILD_HOSPITAL_SUPPORT: 1000, 
        PREVIOUS_DEDUCTION: 1000 
    };
    
    // تعريف مخصصات المناصب الإدارية
    const POSITION_DEDUCTIONS = {
        'section-head': 0.15,      
        'department-head': 0.20,   
        'director': 0.30           
    };
    
    // تعريف أسعار الساعات الإضافية/المناوبة حسب الدرجة
    const OVERTIME_RATES = {
        'high_grade': 5000, // للدرجات 4 و 3 و 2 و 1
        'low_grade': 4000   // للدرجات 8 و 7 و 6 و 5
    };

    // دالة لتحديد سعر الساعة بناءً على الدرجة
    function getRatePerHoure(grade) {
        if (grade >= 5 && grade <= 8) {
            return OVERTIME_RATES.low_grade; // 4000 دينار للدرجات 8-5
        } else if (grade >= 1 && grade <= 4) {
            return OVERTIME_RATES.high_grade; // 5000 دينار للدرجات 4-1
        }
        return 0;
    }
    
    // دالة مساعدة لحساب الراتب الكلي
    function calculateFullSalary(targetGrade, targetStage, degree, workType, locationAllowance, social, kids, positionFactor = 0, bonusMonths = 0, workShift = 'morning', overtimeHoursInput = 0, shifts = 6) {
        // 1. الراتب الاسمي
        const nominal = gradeBase[targetGrade] + ((targetStage - 1) * stageAddLogic(targetGrade));

        // 2. حساب المعاملات الموحدة
        let certFactor;
        switch (degree) {
            case 'diploma': certFactor = 0.35; break;
            case 'bachelor': certFactor = 0.45; break;
            case 'master': certFactor = 0.65; break;
            case 'phd': certFactor = 0.75; break;
            default: certFactor = 0;
        }

        const riskFactor = workType === 'field' ? 0.3 : 0.25;
        
        let conditionalFactor = 0; 
        
        if (degree !== 'diploma') {
            conditionalFactor = workType === 'field' ? 0.50 : 0.35;
        }
        
        const fixedOtherAllowanceFactor = 0.3; 

        const totalFactors = certFactor + riskFactor + conditionalFactor + fixedOtherAllowanceFactor;
        const factoredAllowance = Math.round(nominal * totalFactors); 

        // 3. مخصصات الزوجية والأطفال
        let familyAllowance = 0;
        if (social === "married") {
            familyAllowance = 50000 + kids * 10000; 
        }
        
        // 4. مخصصات المسؤولية
        const responsibilityAllowance = Math.round(nominal * positionFactor);
        
        // 5. مخصصات "أشهر القدم" (كتب الشكر)
        const bonusAmount = Math.round(nominal * (bonusMonths / 12));
        
        // 6. حساب بدل الساعات الإضافية أو المناوبة
        let specialAllowance = 0;
        let specialAllowanceDetails = {
            type: 'None', 
            hours: 0, 
            rate: 0,
            shiftList: '' // **NEW: لتفاصيل الشفتات**
        };
        
        const ratePerHoure = getRatePerHoure(targetGrade);

        if (workShift === 'morning' && overtimeHoursInput > 0) {
            // حساب الساعات الإضافية (صباحي)
            specialAllowance = overtimeHoursInput * ratePerHoure;
            specialAllowanceDetails.type = 'Overtime';
            specialAllowanceDetails.hours = overtimeHoursInput;
            specialAllowanceDetails.rate = ratePerHoure;
        } else if (workShift === 'shift') {
            // حساب بدل المناوبة (مناوب)
            const hours = (shifts * 24) - 154;
            if (hours > 0) {
                 specialAllowance = hours * ratePerHoure;
            }
            specialAllowanceDetails.type = 'Shift';
            specialAllowanceDetails.hours = hours;
            specialAllowanceDetails.rate = ratePerHoure;

            // **NEW: تحديد تفاصيل الشفتات لـ 7 و 8**
            if (shifts === 7) {
                specialAllowanceDetails.shiftList = "صباحي, مسائي, ليلي, صباحي, مسائي, ليلي, صباحي";
            } else if (shifts === 8) {
                specialAllowanceDetails.shiftList = "مسائي, ليلي, صباحي, مسائي, ليلي, صباحي, مسائي, ليلي";
            } else {
                specialAllowanceDetails.shiftList = "لا يوجد تفصيل للشفتات";
            }
        }

        // 7. الاستقطاعات
        const retirement = Math.round(0.1 * nominal);
        const fixedDeductions = DEDUCTIONS.HEALTH_INSURANCE + DEDUCTIONS.SOCIAL_SOLIDARITY + DEDUCTIONS.CHILD_HOSPITAL_SUPPORT + DEDUCTIONS.PREVIOUS_DEDUCTION;
        const totalDeductions = retirement + fixedDeductions;
        
        // 8. الراتب الكلي (الصافي) 
        const totalSalary = (nominal + factoredAllowance + locationAllowance + familyAllowance + responsibilityAllowance + bonusAmount + specialAllowance) - totalDeductions;
        
        return { nominal, totalSalary, responsibilityAllowance, totalDeductions, bonusAmount, factoredAllowance, specialAllowance, specialAllowanceDetails };
    }

    // دالة جديدة لحساب سنوات الخدمة الفعلية بدقة
    function calculateServiceDuration(startDate) {
        if (!startDate) return null;
        
        const start = new Date(startDate);
        const now = new Date();

        let years = now.getFullYear() - start.getFullYear();
        let months = now.getMonth() - start.getMonth();
        let days = now.getDate() - start.getDate();

        if (days < 0) {
            months--;
            const daysInPreviousMonth = new Date(now.getFullYear(), now.getMonth(), 0).getDate();
            days += daysInPreviousMonth;
        }

        if (months < 0) {
            years--;
            months += 12;
        }
        
        if (years < 0) {
            return "تاريخ تعيين غير صحيح"; 
        }

        return { years, months, days };
    }


    // الدوال الأساسية للتحكم بعرض الحقول
    function toggleKids() {
        // يبقى منطق الإخفاء مرتبطاً فقط بـ "متزوج"
        document.getElementById("kidsBox").classList.toggle(
            "hidden",
            document.getElementById("social").value !== "married"
        );
    }
    
    // دالة للتحكم بعرض حقل الشفتات والساعات الإضافية
    function toggleShiftsAndOvertime() {
        const workShift = document.getElementById("workShift").value;
        
        // إظهار حقل الساعات الإضافية للصباحي
        document.getElementById("overtimeHoursBox").classList.toggle("hidden", workShift !== 'morning');
        
        // إظهار حقل الشفتات للمناوب
        document.getElementById("shiftsBox").classList.toggle("hidden", workShift !== 'shift');
    }
    
    // دالة حساب جميع النتائج
    function calculateAll() {
        // الإخفاء الأولي لكل العناصر القابلة للإخفاء
        document.querySelectorAll('.result').forEach(el => el.classList.add('hidden'));
        document.getElementById("detailsBox").classList.add('hidden');
        
        // جلب المدخلات
        const dateOfAppointment = document.getElementById("dateOfAppointment").value;
        const grade = parseInt(document.getElementById("grade").value);
        const stage = parseInt(document.getElementById("stage").value);
        const degree = document.getElementById("degreeType").value; 
        const workType = document.getElementById("workType").value;   
        const locationAllowance = parseInt(document.getElementById("locationAllowance").value) || 0;
        const social = document.getElementById("social").value;
        const kids = parseInt(document.getElementById("kids").value) || 0;
        const bonusMonths = parseInt(document.getElementById("bonusMonths").value) || 0;
        const workShift = document.getElementById("workShift").value;
        
        // جلب قيم الساعات/الشفتات (يجب التحويل إلى رقم، واستخدام صفر إذا كان فارغاً)
        const overtimeHoursInput = parseInt(document.getElementById("overtimeHoursInput").value) || 0;
        const shifts = parseInt(document.getElementById("shifts").value) || 6;
        
        // جلب قيمة المنصب مباشرة
        const position = document.getElementById("position").value;
        const positionFactor = position === 'none' ? 0 : (POSITION_DEDUCTIONS[position] || 0);
        
        // 1. حساب الراتب الحالي (الصافي) 
        const { nominal: currentNominal, totalSalary: currentTotalSalary, responsibilityAllowance, totalDeductions, bonusAmount, factoredAllowance, specialAllowance, specialAllowanceDetails } = 
            calculateFullSalary(grade, stage, degree, workType, locationAllowance, social, kids, positionFactor, bonusMonths, workShift, overtimeHoursInput, shifts);
        
        // 2. عرض نتائج الراتب
        document.getElementById("salaryResult").classList.remove('hidden');
        document.getElementById("salaryResult").innerHTML =
            "الراتب الصافي: <span>" + currentTotalSalary.toLocaleString() + "</span> دينار";
            
        // 3. حساب وعرض سنوات الخدمة
        const service = calculateServiceDuration(dateOfAppointment);
        const serviceElement = document.getElementById("serviceDuration");
        
        if (service && typeof service !== 'string') {
            serviceElement.innerHTML = 
                `سنوات الخدمة الفعلية: 
                (${service.years}) سنة و 
                (${service.months}) شهر و 
                (${service.days}) يوم.`;
            serviceElement.classList.remove('hidden');
        } else if (typeof service === 'string') {
            alert(service); 
        }

        // 4. تفاصيل الحسابات (الراتب الحالي)
        
        // **********************************************
        // 1. جلب النصوص المعروضة في حقول الإدخال
        // **********************************************
        const degreeText = document.getElementById("degreeType").selectedOptions[0].textContent;
        const workShiftText = document.getElementById("workShift").selectedOptions[0].textContent;
        const socialText = document.getElementById("social").selectedOptions[0].textContent; 
        const kidsText = document.getElementById("kids").value; 
        
        // تنسيق تاريخ التعيين إلى yyyy/mm/dd
        const formattedDate = dateOfAppointment ? dateOfAppointment.replace(/-/g, '/') : "غير مُدخل"; 
        
        // جلب نصوص المنصب وتصنيف الوظيفة
        const positionText = document.getElementById("position").selectedOptions[0].textContent; 
        const workTypeText = document.getElementById("workType").selectedOptions[0].textContent;
        
        
        let certFactor = 0;
        switch (degree) {
            case 'diploma': certFactor = 0.35; break;
            case 'bachelor': certFactor = 0.45; break;
            case 'master': certFactor = 0.65; break;
            case 'phd': certFactor = 0.75; break;
            default: certFactor = 0;
        }
        let riskFactor = workType === 'field' ? 0.3 : 0.25;
        
        // ** التعديل المطلوب: إخفاء المخصص الخاص للدبلوم **
        let conditionalFactor = 0; 
        let conditionalFactorName = "مخصصات هندسية";
        if (degree !== 'diploma') {
            conditionalFactor = workType === 'field' ? 0.50 : 0.35;
            conditionalFactorName = "مخصصات هندسية";
        }
        // **************************************************
        
        let fixedOtherAllowanceFactor = 0.3;
        
        const certAmount = Math.round(currentNominal * certFactor);
        const riskAmount = Math.round(currentNominal * riskFactor);
        const otherFixedAmount = Math.round(currentNominal * fixedOtherAllowanceFactor);
        const conditionalAmount = Math.round(currentNominal * conditionalFactor);
        
        let familyAllowance = social === "married" ? (50000 + kids * 10000) : 0;
        let retirement = Math.round(0.1 * currentNominal);
        
        const fixedDeductions = DEDUCTIONS.HEALTH_INSURANCE + DEDUCTIONS.SOCIAL_SOLIDARITY + DEDUCTIONS.CHILD_HOSPITAL_SUPPORT + DEDUCTIONS.PREVIOUS_DEDUCTION;
        
        // إجمالي المخصصات التي تدخل في الراتب الصافي
        const totalAllowancesWithoutNominal = factoredAllowance + locationAllowance + familyAllowance + responsibilityAllowance + bonusAmount + specialAllowance;
        
        // الراتب الكلي (الإجمالي) = الراتب الصافي + الاستقطاعات
        const grossSalary = currentTotalSalary + totalDeductions;

        let responsibilityText = '';
        if (position !== 'none' && positionFactor > 0) {
            const positionName = document.getElementById("position").selectedOptions[0].textContent;
            responsibilityText = `<li>مخصصات مسؤولية (${positionName}) (${(positionFactor * 100).toFixed(0)}%): <span>${responsibilityAllowance.toLocaleString()}</span> دينار</li>`;
        }
        
        let bonusText = '';
        if (bonusMonths > 0) {
            bonusText = `<li>مكافأة أشهر القدم (${bonusMonths} شهر): <span>${bonusAmount.toLocaleString()}</span> دينار</li>`;
        }

        // عرض بدل الساعات الإضافية - تم تبسيط العرض لإظهار النتيجة فقط
        let specialAllowanceText = '';
        // ** تم حذف منطق عرض تفاصيل الشفتات من المخصصات هنا **
        if (specialAllowance > 0) {
             specialAllowanceText = `<li>بدل الساعات الإضافية/المناوبة: <span>${specialAllowance.toLocaleString()}</span> دينار</li>`;
        }
        
        // تحديد نص عدد الشفتات ليظهر فقط إذا كان الدوام مناوباً وعدد الشفتات ليس 6
        let shiftsDetailText = '';
        if (workShift === 'shift' && shifts !== 6) {
            shiftsDetailText = `<li>عدد الشفتات المُحتسب: <span>${shifts}</span> شفت</li>`;
        }

        // إنشاء سطر المخصص الخاص (المخصص الهندسي)
        let conditionalAllowanceLine = '';
        if (conditionalFactor > 0) {
            conditionalAllowanceLine = `<li>${conditionalFactorName} (${(conditionalFactor * 100).toFixed(0)}%): <span>${conditionalAmount.toLocaleString()}</span> دينار</li>`;
        }


        // **********************************************
        // 2. تحديث المحتوى بإضافة القيم الجديدة
        // **********************************************
        document.getElementById("detailsBox").innerHTML =
            "<h3> قصاصة الراتب:</h3>" + 
            "<div style='background: #f1f1f1; padding: 10px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ddd;'>" +
            "<strong>البيانات الأساسية:</strong>" +
            "<ul>" +
            `<li>تاريخ التعيين: <span>${formattedDate}</span></li>` +
            `<li>الدرجة: <span>${grade}</span>، المرحلة: <span>${stage}</span></li>` +
            `<li>الشهادة: <span>${degreeText}</span></li>` +
            
            `<li>المنصب الحالي: <span>${positionText}</span></li>` +
            `<li>تصنيف الوظيفة: <span>${workTypeText}</span></li>` +
            
            `<li>نوع الدوام: <span>${workShiftText}</span></li>` +
            (shiftsDetailText ? shiftsDetailText : '') + // إضافة عدد الشفتات بشرط المناوبة وعدم كونها 6
            
            `<li>الحالة الاجتماعية: <span>${socialText}</span></li>` +
            `<li>عدد الأطفال: <span>${kidsText}</span></li>` +
            "</ul>" +
            "</div>" +
            
            "<strong>الراتب الاسمي:</strong> <span>" + currentNominal.toLocaleString() + "</span> دينار<br>" +
            "<hr style='margin: 8px 0; border-top: 1px dashed #ccc;'>" +
            "<h4> المخصصات:</h4>" +
            "<ul> " + 
                `<li>مخصصات شهادة (${(certFactor * 100).toFixed(0)}%): <span>${certAmount.toLocaleString()}</span> دينار</li>` +
                `<li>مخصصات خطورة (${(riskFactor * 100).toFixed(0)}%): <span>${riskAmount.toLocaleString()}</span> دينار</li>` +
                `<li>مخصصات ثابتة (30%): <span>${otherFixedAmount.toLocaleString()}</span> دينار</li>` + 
                (conditionalAllowanceLine ? conditionalAllowanceLine : '') + // عرض المخصص الخاص (يُعرض فقط إذا كان العامل أكبر من صفر)
                `<li>مخصصات الزوجية والأطفال: <span>${familyAllowance.toLocaleString()}</span> دينار</li>` +
                (responsibilityText ? responsibilityText : '') +
                (bonusText ? bonusText : '') +
                (specialAllowanceText ? specialAllowanceText : '') + // عرض بدل الساعات الإضافية/المناوبة (النتيجة فقط)
                `<li>مخصصات الموقع: <span>${locationAllowance.toLocaleString()}</span> دينار</li>` +
            "</ul>" +
            "<hr style='margin: 8px 0; border-top: 1px dashed #ccc;'>" +
            "<strong>إجمالي المخصصات الصافية:</strong> <span>" + totalAllowancesWithoutNominal.toLocaleString() + "</span> دينار<br>" + 
            "<hr style='margin: 8px 0; border-top: 1px dashed #ccc;'>" +
            "<h4>➖ الاستقطاعات:</h4>" +
            "<ul> " + 
                `<li>تقاعدة(10%): <span>${retirement.toLocaleString()}</span> دينار</li>` +
                `<li>ضمان صحي: <span>${DEDUCTIONS.HEALTH_INSURANCE.toLocaleString()}</span> دينار</li>` +
                `<li>تكافل اجتماعي: <span>${DEDUCTIONS.SOCIAL_SOLIDARITY.toLocaleString()}</span> دينار</li>` +
                `<li>دعم مستشفى الطفل: <span>${DEDUCTIONS.CHILD_HOSPITAL_SUPPORT.toLocaleString()}</span> دينار</li>` +
                `<li>ما قبله: <span>${DEDUCTIONS.PREVIOUS_DEDUCTION.toLocaleString()}</span> دينار</li>` +
            "</ul>" +
            "<hr style='margin: 8px 0; border-top: 1px solid var(--primary-color);'>" + // خط فاصل واضح
            `<strong>الراتب الكلي:</strong> <span>${grossSalary.toLocaleString()}</span> دينار<br>` +
            "<hr style='margin: 8px 0; border-top: 1px solid var(--primary-color);'>" + // خط فاصل واضح
            "<strong>الراتب الصافي:</strong> <span>" + currentTotalSalary.toLocaleString() + "</span> دينار";

        document.getElementById("detailsBox").classList.remove('hidden');
        
        document.getElementById("printBtn").style.display = 'flex';
    }
    
    // دالة طباعة مباشرة (بدلاً من حفظ PDF)
    function printResults() {
        if (document.getElementById("salaryResult").classList.contains('hidden')) {
            alert("⚠️ يرجى إجراء عملية الحساب أولاً قبل محاولة الطباعة.");
            return;
        }

        window.print();
    }

    // دالة التصفير
    function resetForm() {
        document.getElementById("salaryForm").reset();
        
        document.getElementById("locationAllowance").value = '';
        document.getElementById("bonusMonths").value = 0;
        document.getElementById("dateOfAppointment").value = ""; 
        document.getElementById("overtimeHoursInput").value = ""; 
        
        document.getElementById("position").value = "none";
        
        document.getElementById("workShift").value = "morning";
        document.getElementById("shifts").value = "6";
        
        // تم إزالة الكلاس hidden من kidsBox لضمان ظهوره عند اختيار متزوج
        document.getElementById("kidsBox").classList.add('hidden'); // يجب إعادته مخفياً افتراضياً، وسيتم إظهاره إذا تم اختيار متزوج

        
        // إظهار وإخفاء عند التصفير لضمان التوافق مع القيمة الافتراضية
        toggleShiftsAndOvertime();
        
        document.getElementById("printBtn").style.display = 'none';
        
        document.querySelectorAll('.result').forEach(el => el.classList.add('hidden'));
        document.getElementById("detailsBox").classList.add('hidden');
    }

    // ربط الدوال بالأحداث
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById("social").addEventListener('change', toggleKids);
        document.getElementById("workShift").addEventListener('change', toggleShiftsAndOvertime);
        document.getElementById("calculateBtn").addEventListener('click', calculateAll);
        document.getElementById("resetBtn").addEventListener('click', resetForm);
        document.getElementById("printBtn").addEventListener('click', printResults);

        toggleKids();
        // يتم استدعاء resetForm في النهاية لضبط القيم الافتراضية وتفعيل toggle
        resetForm(); 
    });
</script>

</body>
</html>
